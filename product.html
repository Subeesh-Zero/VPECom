<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Details</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2874f0; /* Flipkart Blue */
            --orange: #fb641b; /* Buy Button */
            --white: #ffffff;
            --grey: #878787;
            --green: #388e3c;
            --bg: #f1f3f6;
        }

        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg); padding-bottom: 70px; -webkit-tap-highlight-color: transparent; }

        /* --- HEADER --- */
        header { 
            background: var(--primary); padding: 12px 15px; position: sticky; top: 0; z-index: 100; 
            display: flex; align-items: center; gap: 15px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .header-title { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .icon-btn { font-size: 18px; cursor: pointer; color: white; }

        /* --- IMAGE SLIDER --- */
        .slider-wrapper { background: white; position: relative; width: 100%; aspect-ratio: 1/1; border-bottom: 1px solid #f0f0f0; }
        .slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: 100%; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }
        .slide { flex: 0 0 100%; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; position: relative; }
        .slide img { max-width: 95%; max-height: 95%; object-fit: contain; }

        .dots-container { position: absolute; bottom: 15px; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; }
        .dot { width: 6px; height: 6px; background: #d1d5db; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--primary); width: 16px; border-radius: 10px; }

        .share-fab { position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); color: #555; z-index: 10; cursor: pointer; }

        /* --- INFO CARD --- */
        .card { background: white; padding: 15px; margin-bottom: 8px; border-bottom: 1px solid #e0e0e0; }
        .p-cat { font-size: 12px; color: var(--grey); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .p-title { font-size: 16px; color: #212121; margin: 5px 0 8px; line-height: 1.4; }
        .price-box { display: flex; align-items: baseline; gap: 10px; }
        .p-price { font-size: 24px; font-weight: 500; color: #212121; }
        .p-mrp { font-size: 14px; color: var(--grey); text-decoration: line-through; }
        .p-off { font-size: 14px; color: var(--green); font-weight: 700; }

        .features { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 15px; }
        .feat-item { text-align: center; font-size: 10px; color: #555; flex: 1; }
        .feat-icon { font-size: 20px; color: var(--primary); margin-bottom: 5px; display: block; }

        /* --- DESCRIPTION --- */
        .desc-head { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #212121; }
        .desc-content { font-size: 14px; color: #444; line-height: 1.6; white-space: pre-line; }

        /* --- SIMILAR PRODUCTS --- */
        .scroll-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .mini-card { min-width: 140px; border: 1px solid #f0f0f0; border-radius: 6px; padding: 8px; background: white; }
        .mini-img { width: 100%; height: 100px; object-fit: contain; margin-bottom: 5px; }
        .mini-title { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
        .mini-price { font-weight: 600; font-size: 13px; color: #212121; margin-top: 2px; }

        /* --- STICKY FOOTER --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 999; }
        .btn { flex: 1; border: none; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-cart { background: white; color: #212121; }
        .btn-buy { background: var(--orange); color: white; }

        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <i class="fas fa-arrow-left icon-btn" onclick="history.back()"></i>
        <div class="header-title" id="headerTitle">Product Details</div>
        <i class="fas fa-shopping-cart icon-btn"></i>
    </header>

    <div id="loading" class="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>

    <div id="mainContent" style="display:none;">
        <div class="slider-wrapper">
            <div class="share-fab" onclick="shareLink()"><i class="fas fa-share-alt"></i></div>
            <div class="slider" id="imgSlider" onscroll="updateDots()"></div>
            <div class="dots-container" id="dots"></div>
        </div>

        <div class="card">
            <div class="p-cat" id="cat">Category</div>
            <div class="p-title" id="title">Loading Title...</div>
            <div class="price-box">
                <div class="p-price" id="price">â‚¹0</div>
                <div class="p-mrp" id="mrp">â‚¹0</div>
                <div class="p-off" id="off">0% off</div>
            </div>
            <div class="features">
                <div class="feat-item"><i class="fas fa-check-circle feat-icon"></i>Original</div>
                <div class="feat-item"><i class="fas fa-shipping-fast feat-icon"></i>Instant</div>
                <div class="feat-item"><i class="fas fa-lock feat-icon"></i>Secure</div>
            </div>
        </div>

        <div class="card">
            <div class="desc-head">Product Description</div>
            <div class="desc-content" id="desc">No description available.</div>
        </div>

        <div class="card" id="similarSection" style="margin-bottom: 0;">
            <div class="desc-head">Similar Products</div>
            <div class="scroll-row" id="similar"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="btn btn-cart" onclick="alert('Added to Cart')">ADD TO CART</button>
        <button class="btn btn-buy" id="buyBtn">BUY NOW</button>
    </div>

<script>
    const REPO = "Subeesh-Zero/VPECom";
    const BASE_URL = `https://raw.githubusercontent.com/${REPO}/main`;

    let allProducts = [];
    let globalOffer = 0;

    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if(!id) { handleProductError(); return; }
        await loadProduct(id);
    };

    function handleProductError() {
        alert("This product is no longer available.");
        window.location.href = "index.html";
    }

    async function loadProduct(pid) {
        const ts = Date.now();
        try {
            const sRes = await fetch(`${BASE_URL}/settings.json?v=${ts}`);
            if(sRes.ok) {
                const s = await sRes.json();
                if(s.wholeWebsiteOffer) globalOffer = parseInt(s.wholeWebsiteOffer);
            }

            const res = await fetch(`${BASE_URL}/all_products.json?v=${ts}`);
            if(!res.ok) throw new Error("Network Error");
            allProducts = await res.json();

            const product = allProducts.find(p => p.id == pid);
            if(product) {
                renderUI(product);
                renderSimilar(product.category, pid);
            } else {
                handleProductError();
            }
        } catch(e) {
            document.getElementById('loading').innerHTML = "Error loading. Check connection.";
        }
    }

    function renderUI(p) {
        let originalPrice = parseInt(p.price);
        let pOffer = parseInt(p.offer) || 0;
        let finalOffer = Math.max(globalOffer, pOffer);
        let finalPrice = Math.floor(originalPrice - (originalPrice * finalOffer / 100));

        document.getElementById('headerTitle').innerText = p.title;
        document.getElementById('cat').innerText = p.category;
        document.getElementById('title').innerText = p.title;
        document.getElementById('price').innerText = `â‚¹${finalPrice}`;
        document.getElementById('mrp').innerText = `â‚¹${originalPrice}`;
        document.getElementById('off').innerText = `${finalOffer}% off`;
        
        if(finalOffer === 0) {
            document.getElementById('mrp').style.display = 'none';
            document.getElementById('off').style.display = 'none';
        }

        if(p.description) document.getElementById('desc').innerText = p.description;
        document.getElementById('buyBtn').onclick = () => window.location.href = p.buyLink;

        const slider = document.getElementById('imgSlider');
        const dots = document.getElementById('dots');
        let images = (p.images && p.images.length > 0) ? p.images : [p.image];

        images.forEach((img, index) => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'slide';
            // ðŸ”¥ Magic Fix: If image fails to load, trigger global error
            slideDiv.innerHTML = `<img src="${img}" onerror="handleProductError()">`;
            slider.appendChild(slideDiv);

            const dotDiv = document.createElement('div');
            dotDiv.className = `dot ${index === 0 ? 'active' : ''}`;
            dots.appendChild(dotDiv);
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    }

    function renderSimilar(cat, currentId) {
        const container = document.getElementById('similar');
        const similar = allProducts.filter(p => p.category === cat && p.id != currentId);
        if(similar.length === 0) {
            document.getElementById('similarSection').style.display = 'none';
            return;
        }
        similar.forEach(p => {
            let img = p.images ? p.images[0] : p.image;
            container.innerHTML += `
                <div class="mini-card" onclick="window.location.href='product.html?id=${p.id}'">
                    <img src="${img}" class="mini-img" onerror="this.parentElement.style.display='none'">
                    <div class="mini-title">${p.title}</div>
                    <div class="mini-price">â‚¹${p.price}</div>
                </div>
            `;
        });
    }

    function updateDots() {
        const slider = document.getElementById('imgSlider');
        const dots = document.querySelectorAll('.dot');
        const activeIndex = Math.round(slider.scrollLeft / slider.offsetWidth);
        dots.forEach((dot, index) => dot.classList.toggle('active', index === activeIndex));
    }

    function shareLink() {
        const url = window.location.href;
        if(navigator.share) navigator.share({ title: document.getElementById('title').innerText, url: url });
        else { navigator.clipboard.writeText(url); alert("Link Copied!"); }
    }
</script>
</body>
</html>
